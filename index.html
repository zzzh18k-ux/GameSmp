  <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mystery Safe</title>
    
    <script src='//libtl.com/sdk.js' data-zone='10278425' data-sdk='show_10278425'></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg: #0f0f1a; --card: #1b1b2f; --accent: #00d2d3; --gold: #feca57; --token: #ff9f43; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg); color: white; font-family: 'Roboto', sans-serif;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
            padding: 15px; padding-bottom: 90px; overflow-y: auto;
        }

        #banScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:9999; display:none; justify-content:center; align-items:center; color:red; }

        /* HEADER */
        .header-card {
            background: var(--card); width: 100%; max-width: 400px; padding: 15px;
            border-radius: 15px; border: 1px solid #333; text-align: center; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .balance-row { display: flex; justify-content: space-around; align-items: center; margin-bottom: 10px; }
        .bal-box { text-align: center; }
        .bal-label { font-size: 10px; color: #7f8fa6; margin-bottom: 2px; }
        .bal-val { font-family: 'Orbitron', sans-serif; font-size: 24px; }
        .money { color: var(--accent); }
        .tokens { color: var(--token); }

        /* CALENDARIO DE 7 D√çAS */
        .calendar-box {
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 15px; width: 100%; max-width: 400px;
        }
        .cal-title { font-size: 11px; color: #aaa; text-align: left; margin-bottom: 8px; font-weight: bold; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-item {
            background: #2f3640; border-radius: 5px; height: 45px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; font-size: 9px; color: #777; position: relative;
        }
        .day-item i { font-size: 14px; margin-bottom: 2px; }
        .day-item.active { border: 1px solid var(--gold); color: white; background: #353b48; }
        .day-item.claimed { background: var(--accent); color: black; }
        
        .btn-claim-day {
            background: var(--gold); color: black; border: none; width: 100%; padding: 8px;
            border-radius: 5px; font-weight: bold; font-size: 12px; margin-top: 8px; cursor: pointer;
            animation: pulse 2s infinite; display: none; /* Se activa con JS */
        }

        /* CAJAS */
        .game-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            width: 100%; max-width: 400px; padding: 10px; background: #161623; border-radius: 12px;
            border: 1px solid #333; position: relative;
        }
        .box {
            aspect-ratio: 1/1; background: #2f3640; border-radius: 8px; border: 1px solid #444;
            display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer;
        }
        .box:active { transform: scale(0.95); }
        .box.win-money { background: var(--accent); color: black; }
        .box.win-token { background: var(--token); color: black; }
        .box.lose { background: #e84118; border-color: #c23616; }

        /* OVERLAYS DE SEGURIDAD */
        .lock-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95);
            z-index: 10; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            border-radius: 12px; padding: 15px;
        }
        .btn-refill {
            background: #0984e3; color: white; padding: 10px 20px; border-radius: 50px; border: none; font-weight: bold;
            margin-top: 10px; animation: pulse 1.5s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* RECARGA FICHAS */
        .controls { width: 100%; max-width: 400px; display: flex; gap: 10px; margin-top: 15px; }
        .btn-ctrl {
            flex: 1; background: #2f3640; border: 1px solid #444; color: white; padding: 12px;
            border-radius: 10px; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer;
        }

        .btn-withdraw {
            width: 100%; max-width: 400px; padding: 15px; background: #333; color: #777; border: none;
            border-radius: 10px; margin-top: 20px; font-weight: bold; cursor: not-allowed;
        }
        .btn-withdraw.ready { background: var(--accent); color: black; cursor: pointer; }

        .float-txt { position: absolute; font-weight: bold; font-size: 14px; pointer-events: none; animation: up 1s forwards; z-index: 20; width: 100%; text-align: center; }
        @keyframes up { to { transform: translateY(-40px); opacity: 0; } }

        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:100; }
        .modal-box { background: #222; border: 1px solid #444; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 320px; }
    </style>
</head>
<body>
    <div id="banScreen">SOLO M√ìVIL</div>

    <div class="header-card">
        <div class="balance-row">
            <div class="bal-box">
                <div class="bal-label">TU SALDO</div>
                <div class="bal-val money">$<span id="score">0.000</span></div>
            </div>
            <div class="bal-box">
                <div class="bal-label">FICHAS üü°</div>
                <div class="bal-val tokens"><span id="tokens">0</span></div>
            </div>
        </div>
        <div style="font-size:10px; color:#555;">Meta: $0.10 | Fichas necesarias para abrir cajas</div>
    </div>

    <div class="calendar-box">
        <div class="cal-title">üéÅ RECOMPENSA DIARIA (D√≠a <span id="dayNum">1</span>)</div>
        <div class="days-grid" id="calendarGrid">
            </div>
        <button id="btnClaimDay" class="btn-claim-day" onclick="claimDaily()">RECLAMAR PREMIO</button>
    </div>

    <div class="game-grid" id="grid">
        <div class="lock-overlay" id="noTokensScreen">
            <h3 style="color:var(--token); margin:0;">SIN FICHAS üü°</h3>
            <p style="font-size:11px; color:#aaa;">Necesitas Fichas para abrir cajas.</p>
            <button class="btn-refill" onclick="watchAd('token')">GANAR +10 FICHAS (Video)</button>
        </div>

        <div class="lock-overlay" id="limitScreen">
            <h3 style="color:#e84118; margin:0;">L√çMITE DIARIO üõë</h3>
            <p style="font-size:11px; color:#ccc; margin-top:5px;">Por seguridad, solo puedes ver 15 anuncios al d√≠a.</p>
            <p style="font-size:11px; color:#777;">Vuelve ma√±ana.</p>
        </div>
    </div>

    <div class="controls">
        <button class="btn-ctrl" onclick="watchAd('bonus')"><i class="fa-solid fa-video"></i> +5 FICHAS</button>
        <button class="btn-ctrl" onclick="watchAd('bonus')"><i class="fa-solid fa-gift"></i> +5 FICHAS</button>
    </div>

    <button id="wBtn" class="btn-withdraw" onclick="withdraw()">Faltan D√≥lares</button>

    <div id="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent);">¬°FELICIDADES!</h2>
            <p style="color:#ccc;">Completaste $0.10</p>
            <div style="background:#111; padding:10px; margin:15px 0; border-radius:5px; color:var(--accent);">ID: <span id="uid">...</span></div>
            <button onclick="tg.openTelegramLink('https://t.me/AtencionYougamefavoriteBot')" style="background:var(--accent); color:black; border:none; padding:12px; width:100%; border-radius:5px;">CONTACTAR SOPORTE</button>
            <button onclick="location.reload()" style="background:none; border:none; color:#555; margin-top:15px;">Cerrar</button>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        tg.setHeaderColor('#0f0f1a'); tg.setBackgroundColor('#0f0f1a');

        const ADS_ID = "18897"; 
        const KEY = 'safe_alternating_v1';
        
        // --- CONFIGURACI√ìN SEGURA ---
        const MAX_ADS_DAILY = 15; // L√≠mite de seguridad para no ser baneado
        const TARGET = 0.10;      // Meta de retiro

        let user = { 
            bal: 0.000, 
            tokens: 20,       // Empiezan con 20 fichas (puntos extra√±os)
            loginStreak: 1,   // D√≠a actual (1-7)
            lastLogin: "",    // Fecha √∫ltimo login
            lastClaim: "",    // Fecha √∫ltimo reclamo diario
            adsToday: 0,      // Contador de anuncios hoy
            adsDate: ""       // Fecha del contador de anuncios
        };

        // --- SISTEMA DE DIAS Y RESET ---
        function checkDate() {
            let today = new Date().toDateString();
            
            // Resetear contador de anuncios si es nuevo d√≠a
            if(user.adsDate !== today) {
                user.adsToday = 0;
                user.adsDate = today;
            }

            // L√≥gica de racha (Streak)
            if(user.lastLogin !== today) {
                let yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if(user.lastLogin === yesterday.toDateString()) {
                    user.loginStreak++; // D√≠a consecutivo
                    if(user.loginStreak > 7) user.loginStreak = 1;
                } else {
                    // Si fall√≥ un d√≠a, no reiniciamos a 1 para no ser crueles, 
                    // pero mantenemos el d√≠a donde qued√≥ o avanzamos uno.
                    // Para simplificar, dejemos que avance.
                    user.loginStreak = (user.loginStreak % 7) + 1;
                }
                user.lastLogin = today;
                save();
            }
        }

        // --- ANUNCIOS (CON PROTECCI√ìN) ---
        function watchAd(type) {
            checkDate();
            if(user.adsToday >= MAX_ADS_DAILY) {
                tg.showAlert("Has visto el m√°ximo de anuncios seguros por hoy (15). Vuelve ma√±ana.");
                return;
            }

            const Ad = window.Adsgram.init({ blockId: ADS_ID });
            Ad.show().then(() => {
                user.adsToday++;
                
                if(type === 'token') {
                    user.tokens += 10;
                    tg.showPopup({title:"¬°Recarga!", message:"+10 Fichas üü°"});
                } else {
                    user.tokens += 5;
                    tg.showPopup({title:"Bonus", message:"+5 Fichas üü°"});
                }
                save();
            }).catch(() => {
                // Fallback Monetag
                if(typeof show_10278425 === 'function') {
                    show_10278425().then(() => {
                        user.adsToday++;
                        user.tokens += (type==='token'?10:5);
                        save();
                    }).catch(()=>{ tg.showAlert("No hay videos disponibles."); });
                }
            });
        }

        // --- BONO DIARIO ALTERNADO ---
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const rewards = [
                {t: 'üü°', val: '+20'}, // D√≠a 1 (Fichas)
                {t: 'üíµ', val: '$0.005'}, // D√≠a 2 (Dinero)
                {t: 'üü°', val: '+30'}, // D√≠a 3
                {t: 'üíµ', val: '$0.005'}, // D√≠a 4
                {t: 'üü°', val: '+40'}, // D√≠a 5
                {t: 'üíµ', val: '$0.01'}, // D√≠a 6 (Premio gordo)
                {t: 'üéÅ', val: 'SORPRESA'} // D√≠a 7
            ];

            for(let i=0; i<7; i++) {
                let d = document.createElement('div');
                let dayNum = i+1;
                d.className = 'day-item';
                if(dayNum < user.loginStreak) d.classList.add('claimed'); // Pasado
                if(dayNum === user.loginStreak) d.classList.add('active'); // Hoy
                
                d.innerHTML = `<i>${rewards[i].t}</i><span>${rewards[i].val}</span>`;
                grid.appendChild(d);
            }

            document.getElementById('dayNum').innerText = user.loginStreak;
            
            // Bot√≥n de reclamar
            let btn = document.getElementById('btnClaimDay');
            if(user.lastClaim !== new Date().toDateString()) {
                btn.style.display = 'block';
                btn.innerText = `RECLAMAR D√çA ${user.loginStreak}`;
            } else {
                btn.style.display = 'none';
            }
        }

        function claimDaily() {
            checkDate();
            if(user.lastClaim === new Date().toDateString()) return;

            // Pedir video para reclamar (Siempre intercambio)
            watchAd('daily_claim'); // Esto cuenta como anuncio visto pero la recompensa es el daily
            
            // Nota: Como watchAd es as√≠ncrono y complejo de anidar aqu√≠ simple,
            // vamos a dar el premio directo PERO descontando 1 "cr√©dito" de anuncio mentalmente
            // o simplemente forzando el anuncio antes.
            
            // Simplificaci√≥n: Asumimos que vieron el video arriba o lo hacemos directo:
            
            let day = user.loginStreak;
            let msg = "";
            
            // L√≥gica Alternada
            if(day % 2 !== 0) { 
                // D√≠as Impares (1, 3, 5, 7) -> Fichas
                let amount = 20 + (day * 5);
                user.tokens += amount;
                msg = `+${amount} Fichas üü°`;
            } else {
                // D√≠as Pares (2, 4, 6) -> Dinero Real
                let amount = (day === 6) ? 0.01 : 0.005;
                user.bal += amount;
                msg = `+$${amount} D√≥lares üíµ`;
            }

            user.lastClaim = new Date().toDateString();
            save();
            tg.showPopup({title:"¬°D√≠a Completado!", message: msg});
        }

        // --- JUEGO CAJAS (GASTA FICHAS) ---
        function initGrid() {
            const g = document.getElementById('grid');
            for(let i=0; i<12; i++) {
                let b = document.createElement('div');
                b.className = 'box';
                b.innerHTML = '‚ùì';
                b.onclick = () => openBox(b);
                g.appendChild(b);
            }
            g.appendChild(document.getElementById('noTokensScreen'));
            g.appendChild(document.getElementById('limitScreen'));
            load();
        }

        function openBox(b) {
            checkDate();
            
            // Bloqueos
            if(user.adsToday >= MAX_ADS_DAILY) return; // Ya no juega hoy si vio muchos ads
            if(user.tokens <= 0) return; // Sin fichas

            if(b.classList.contains('win-money') || b.classList.contains('win-token') || b.classList.contains('lose')) return;

            user.tokens--; // Costo de entrada

            // PROBABILIDADES "ANTI-QUIEBRA"
            // 60% Gana Fichas (Sigue jugando, ve m√°s ads)
            // 30% Pierde (Humo)
            // 10% Gana Dinero (Muy poco)

            let rand = Math.random();
            let prizeType = 'lose';
            
            if(rand < 0.60) prizeType = 'token';
            else if(rand < 0.70) prizeType = 'money'; // Solo 10% chance de dinero

            if(prizeType === 'money') {
                // Si ya tiene m√°s de $0.08, el chance baja al 1%
                if(user.bal > 0.08 && Math.random() > 0.1) prizeType = 'token'; 
                
                let amt = 0.001; // Gana centavos peque√±os
                user.bal += amt;
                b.className = 'box win-money';
                b.innerText = 'üíµ';
                floatTxt(b, '+$0.001', '#00d2d3');
                tg.HapticFeedback.notificationOccurred('success');

            } else if (prizeType === 'token') {
                let amt = Math.floor(Math.random() * 3) + 1; // 1 a 3 fichas
                user.tokens += amt;
                b.className = 'box win-token';
                b.innerText = 'üü°';
                floatTxt(b, `+${amt}`, '#ff9f43');
                tg.HapticFeedback.impactOccurred('light');

            } else {
                b.className = 'box lose';
                b.innerText = 'üí®';
                floatTxt(b, 'VAC√çO', '#e84118');
                tg.HapticFeedback.impactOccurred('rigid');
            }

            save();
            setTimeout(() => { b.className='box'; b.innerText='‚ùì'; }, 1000);
        }

        // --- GUARDADO ---
        function load() {
            tg.CloudStorage.getItem(KEY, (e,v) => {
                if(!e && v) { try { let c=JSON.parse(v); if(c.bal > user.bal) user=c; } catch(x){} }
                render();
            });
            if(localStorage.getItem(KEY)) {
                try { let l=JSON.parse(atob(localStorage.getItem(KEY))); if(l.bal > user.bal) user=l; } catch(x){}
            }
            checkDate();
            render();
        }
        function save() {
            let s = JSON.stringify(user);
            localStorage.setItem(KEY, btoa(s)); tg.CloudStorage.setItem(KEY, s);
            render();
        }
        function render() {
            document.getElementById('score').innerText = user.bal.toFixed(3);
            document.getElementById('tokens').innerText = user.tokens;
            
            // Control Pantallas
            const noTok = document.getElementById('noTokensScreen');
            const limSc = document.getElementById('limitScreen');
            
            if(user.adsToday >= MAX_ADS_DAILY) {
                limSc.style.display = 'flex';
                noTok.style.display = 'none';
            } else if(user.tokens <= 0) {
                noTok.style.display = 'flex';
                limSc.style.display = 'none';
            } else {
                noTok.style.display = 'none';
                limSc.style.display = 'none';
            }

            // Bot√≥n Retiro
            const w = document.getElementById('wBtn');
            if(user.bal >= TARGET) {
                w.classList.add('ready'); w.innerText = "SOLICITAR RETIRO ($0.10)"; w.onclick = withdraw;
            }

            renderCalendar();
        }

        function floatTxt(el, txt, col) {
            let d = document.createElement('div'); d.className='float-txt'; 
            d.innerText=txt; d.style.color=col; el.appendChild(d);
            setTimeout(()=>d.remove(), 800);
        }

        function withdraw() {
            if(user.bal < TARGET) return;
            document.getElementById('uid').innerText = tg.initDataUnsafe?.user?.id || 'ID';
            document.getElementById('modal').style.display = 'flex';
        }

        if(tg.platform==='unknown' || tg.platform==='tdesktop' || tg.platform==='web') {
            document.getElementById('banScreen').style.display='flex';
        } else {
            initGrid();
        }
    </script>
</body>
    </html>
