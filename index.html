<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Hunter VIP</title>
    
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10278425' data-sdk='show_10278425'></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #050505; --card: #121214; --gold: #FFD700; --gold-grad: linear-gradient(135deg, #FFD700 10%, #FDB931 100%); --accent: #2ecc71; --danger: #ff4757; }
        body { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Montserrat', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* NOTIFICACIONES */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; pointer-events: none; display: flex; flex-direction: column; gap: 8px; }
        .toast { background: rgba(20,20,20,0.95); color: #fff; padding: 12px 20px; border-radius: 12px; font-size: 13px; font-weight: 600; border-left: 4px solid var(--gold); animation: slideIn 0.3s forwards; display: flex; align-items: center; gap: 12px; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* INTERFAZ */
        #app-ui { padding: 20px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .user-badge { background: #1a1a1d; padding: 6px 14px; border-radius: 20px; border: 1px solid #333; font-size: 11px; display: flex; align-items: center; gap: 8px; color: #ccc; }
        
        .balance-card { background: var(--card); border-radius: 24px; padding: 30px 20px; text-align: center; border: 1px solid rgba(255,215,0,0.1); box-shadow: 0 0 50px rgba(255,215,0,0.05); margin-bottom: 20px; position: relative; overflow: hidden; }
        .balance-val { font-size: 46px; font-weight: 900; background: var(--gold-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 10px 0; }
        
        .btn-play { width: 100%; border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 900; color: #000; background: var(--gold-grad); box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; padding-bottom: 10px; }
        .menu-btn { background: #151518; border: 1px solid #2a2a2d; padding: 15px; border-radius: 14px; color: #aaa; font-size: 11px; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        
        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #151518; width: 85%; padding: 30px 25px; border-radius: 24px; border: 1px solid #333; text-align: center; }
        input { width: 100%; padding: 16px; margin: 12px 0; background: #0a0a0c; border: 1px solid #333; border-radius: 12px; color: #fff; font-family: inherit; box-sizing: border-box; font-size: 14px; }
        
        /* CAPAS */
        #game-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: none; }
        .hud { position: absolute; top: 20px; width: 100%; padding: 0 20px; display: flex; justify-content: space-between; box-sizing: border-box; pointer-events: none; }
        .hud-tag { background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 30px; border: 1px solid #444; font-weight: 800; font-size: 14px; }

        /* MANTENIMIENTO */
        #maintenance-layer { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display: flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; display:none; }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="maintenance-layer">
        <i class="fas fa-tools" style="font-size:60px; color:#FFD700; margin-bottom:20px;"></i>
        <h1 style="color:#fff; margin:0;">EN MANTENIMIENTO</h1>
        <p style="color:#aaa; padding:0 40px; margin-top:10px;">Estamos ajustando la econom√≠a del juego para tu seguridad.</p>
        <div style="margin-top:20px; font-size:12px; color:#444;">Tu saldo est√° 100% seguro üîí</div>
    </div>

    <div id="app-ui">
        <div class="header">
            <div class="user-badge"><i class="fas fa-id-card" style="color:var(--gold)"></i> <span id="username">Cargando...</span></div>
            <div class="user-badge">ID: <span id="userid">...</span></div>
        </div>

        <div class="balance-card">
            <div style="font-size:11px; color:var(--gold); letter-spacing:2px; font-weight:700;">SALDO DISPONIBLE</div>
            <div class="balance-val">$<span id="ui-usd">0.0000</span></div>
            <div style="font-size:12px; color:#666;">USDT (Red Polygon)</div>
        </div>

        <button class="btn-play" onclick="preGameAd()">
            <i class="fas fa-bomb" style="color:#000;"></i> CAZAR (Cuidado üí£)
        </button>

        <div class="menu-grid">
            <button class="menu-btn" onclick="openModal('modalGift')"><i class="fas fa-gift" style="color:#e91e63"></i> CANJEAR C√ìDIGO</button>
            
            <button class="menu-btn" onclick="openModal('modalWithdraw')"><i class="fas fa-wallet" style="color:var(--accent)"></i> RETIRAR</button>
            <button class="menu-btn" onclick="copyReferral()"><i class="fas fa-users" style="color:#3498db"></i> INVITAR AMIGOS</button>
            <button class="menu-btn" onclick="openModal('modalHistory')"><i class="fas fa-history" style="color:var(--gold)"></i> HISTORIAL</button>
        </div>
        
        <div id="status-dot" style="text-align:center; font-size:10px; color:#333; margin-top:15px; font-weight:600;">SISTEMA V16 SEGURO</div>
    </div>

    <div id="game-layer">
        <div class="hud">
            <div class="hud-tag" style="color:var(--gold)"><i class="fas fa-star"></i> <span id="score-val">0</span></div>
            <div class="hud-tag" style="color:var(--danger)"><i class="fas fa-clock"></i> <span id="time-val">45</span></div>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <div id="modalWithdraw" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:#fff; margin:0 0 5px 0;">RETIRAR USDT</h2>
            <p style="font-size:11px; color:var(--accent); margin-bottom:20px;">Red Polygon (MATIC) ‚Ä¢ M√≠nimo $5.00</p>
            <input type="number" id="w-amount" placeholder="Monto (Ej: 5.00)">
            <input type="text" id="w-wallet" placeholder="Tu Direcci√≥n de Billetera">
            <button class="btn-play" style="font-size:14px; padding:15px;" onclick="processWithdraw()">CONFIRMAR RETIRO</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; margin-top:15px; width:100%; padding:10px;">Cancelar</button>
        </div>
    </div>

    <div id="modalGift" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:#fff; margin:0 0 5px 0;">üéÅ C√ìDIGO DE REGALO</h2>
            <p style="font-size:11px; color:#aaa; margin-bottom:20px;">Ingresa tu c√≥digo especial</p>
            <input type="text" id="g-code" placeholder="Pega el c√≥digo aqu√≠...">
            <button class="btn-play" style="font-size:14px; padding:15px; background: linear-gradient(135deg, #e91e63, #9c27b0);" onclick="redeemGift()">CANJEAR</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; margin-top:15px; width:100%; padding:10px;">Cerrar</button>
        </div>
    </div>

    <div id="modalHistory" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#fff; margin-bottom:15px;">MOVIMIENTOS</h3>
            <div id="h-list" style="text-align:left; max-height:250px; overflow-y:auto; font-size:12px;"></div>
            <button onclick="closeModals()" style="background:none; border:none; color:#666; margin-top:15px; width:100%;">Cerrar</button>
        </div>
    </div>
        <script>
        // --- üö® CONTROL DE MANTENIMIENTO üö® ---
        // true = JUEGO CERRADO (Nadie entra)
        // false = JUEGO ABIERTO (Todos juegan)
        const MAINTENANCE_MODE = true; 

        // --- CONFIGURACI√ìN ---
        const BOT_TOKEN = "8575758761:AAHM8aRoDIee_iICu4zwSYBuHJcyy7CXH_s"; 
        const CHAT_ID = "-1002118088046"; 
        const ADSGRAM_ID = "18897"; 
        
        // ‚úÖ LLAVE ORIGINAL (Para que NADIE pierda su dinero)
        const KEY = 'fruit_hunter_v13_multi_block'; 
        
        const tg = window.Telegram.WebApp;
        try { tg.expand(); } catch (e) {}

        let user = { 
            usd: 2.0000, 
            history: [], 
            gamesPlayed: 0,
            referrer: null, 
            usedCodes: [] 
        };
        let lastClick = 0;

        // üõë 1. ACTIVAR MANTENIMIENTO
        if (MAINTENANCE_MODE) {
            document.getElementById('maintenance-layer').style.display = 'flex';
            // Detenemos todo. Nadie pasa de aqu√≠.
            throw new Error("MANTENIMIENTO_ACTIVO");
        }

        // üõ°Ô∏è 2. SEGURIDAD M√ìVIL Y MULTICUENTA
        function checkSecurity() {
            const p = tg.platform || "unknown";
            const allowed = ['android', 'android_x', 'ios'];
            const isMob = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
            
            if (!allowed.includes(p) && !isMob) {
                document.body.innerHTML = `<div style="height:100vh; background:#000; color:#ff4757; display:flex; justify-content:center; align-items:center;"><h1>SOLO M√ìVILES</h1></div>`;
                return false;
            }
            // Anti-Multicuenta simple
            const currentID = tg.initDataUnsafe?.user?.id;
            if (currentID) {
                const ownerID = localStorage.getItem('fruit_owner_id');
                if (ownerID && ownerID != currentID) {
                    document.body.innerHTML = `<div style="height:100vh; background:#000; color:#ff4757; display:flex; justify-content:center; align-items:center;"><h1>MULTI-CUENTA DETECTADA</h1></div>`;
                    return false;
                } else {
                    localStorage.setItem('fruit_owner_id', currentID);
                }
            }
            return true;
        }

        function save() {
            localStorage.setItem(KEY, JSON.stringify(user));
            try { tg.CloudStorage.setItem(KEY, JSON.stringify(user)); } catch(e){}
            updateUI();
        }

        function load() {
            // A. Detectar Invitaci√≥n (#ref_ID)
            const hash = window.location.hash;
            if (hash && hash.startsWith('#ref_')) {
                const refID = hash.replace('#ref_', '');
                const myID = tg.initDataUnsafe?.user?.id;
                if (refID && refID != myID) {
                    if (!localStorage.getItem('saved_referrer')) localStorage.setItem('saved_referrer', refID);
                }
            }

            // B. Cargar Datos
            let local = localStorage.getItem(KEY);
            if(local) { user = JSON.parse(local); }
            
            // Recuperar campos nuevos si no existen
            if (!user.referrer) user.referrer = localStorage.getItem('saved_referrer') || null;
            if (!user.usedCodes) user.usedCodes = [];

            updateUI();
            
            // C. Nube
            try {
                tg.CloudStorage.getItem(KEY, (err, val) => {
                    if(!err && val) {
                        let cloudUser = JSON.parse(val);
                        if(cloudUser.gamesPlayed >= user.gamesPlayed) { user = cloudUser; save(); }
                    } else if (!local) { save(); }
                    
                    if(tg.initDataUnsafe?.user?.id) {
                        reportar(`üîî ENTRADA: Saldo $${user.usd.toFixed(4)}`);
                    }
                });
            } catch(e) { }
        }

        function preGameAd() {
            if(Date.now() - lastClick < 2000) return; 
            lastClick = Date.now();
            try { if (typeof show_10278425 === 'function') show_10278425(); } catch(e) { }
            try {
                window.Adsgram.init({ blockId: ADSGRAM_ID }).show().then(() => { startGame(); }).catch(() => { startGame(); });
            } catch(e) { startGame(); }
        }

        function calculatePrize(score) {
            if(score <= 0) return 0;
            // üìâ ECONOM√çA AJUSTADA: 10% si tienes > $3
            let difficulty = user.usd > 3.0 ? 0.1 : 1; 
            
            let rnd = Math.random() * 100;
            let mult = 0.00005; 
            if (rnd < 2 && user.usd < 3.0) { mult = 0.0010; showToast("¬°JACKPOT! Bonus x20", "fas fa-star", "#f1c40f"); } 
            else if (rnd < 20) { mult = 0.0002; }
            return (score * mult * difficulty);
        }

        // üéÅ NUEVO: CANJEAR C√ìDIGO
        function redeemGift() {
            const codeInput = document.getElementById('g-code').value.trim();
            const myID = tg.initDataUnsafe?.user?.id;
            
            if (!codeInput) return showToast("Escribe un c√≥digo", "fas fa-times", "#ff4757");
            if (user.usedCodes.includes(codeInput)) return showToast("C√≥digo ya usado", "fas fa-history", "#ff4757");

            // Formato: GIFT-ID-MONTO (Ej: GIFT-12345-0.50)
            try {
                if (!codeInput.startsWith("GIFT-")) throw "Formato inv√°lido";
                const parts = codeInput.split('-'); 
                const targetID = parts[1];
                const amount = parseFloat(parts[2]);

                if (targetID != myID) return showToast("Este c√≥digo no es para ti", "fas fa-user-lock", "#ff4757");
                if (isNaN(amount)) throw "Monto inv√°lido";

                user.usd += amount;
                user.usedCodes.push(codeInput);
                save();
                
                showToast(`¬°CANJEADO! +$${amount.toFixed(2)}`, "fas fa-check-circle", "#2ecc71");
                reportar(`üéÅ REGALO CANJEADO: $${amount} | C√≥digo: ${codeInput}`);
                closeModals();

            } catch (e) {
                showToast("C√≥digo inv√°lido", "fas fa-times", "#ff4757");
            }
        }

        // JUEGO
        const cvs = document.getElementById('canvas');
        const ctx = cvs.getContext('2d');
        let game = { run:false, score:0, time:45, hook:{}, objs:[] };
        let loopId;

        function startGame() {
            document.getElementById('game-layer').style.display='block';
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            game.objs = [];
            for(let i=0;i<4;i++) game.objs.push({x:Math.random()*cvs.width, y:150+Math.random()*400, r:20, val:50, icon:'üçé', spd:5});
            for(let i=0;i<3;i++) game.objs.push({x:Math.random()*cvs.width, y:150+Math.random()*400, r:20, val:80, icon:'üçá', spd:6});
            game.objs.push({x:Math.random()*cvs.width, y:300, r:25, val:150, icon:'üçâ', spd:3}); 
            for(let i=0;i<3;i++) game.objs.push({x:Math.random()*cvs.width, y:150+Math.random()*400, r:22, val:-200, icon:'üí£', spd:4});
            game.hook = {x:cvs.width/2, y:50, ang:1.57, len:60, st:0, spd:0.03, obj:null};
            game.score=0; game.time=45; game.run=true;
            cvs.onpointerdown = () => { if(game.hook.st===0) game.hook.st=1; };
            loop();
        }

        function loop() {
            if(!game.run) return;
            let h = game.hook;
            if(h.st===0) { h.ang+=h.spd; if(h.ang<0.2||h.ang>2.9) h.spd*=-1; }
            else if(h.st===1) { h.len+=15; if(h.len>cvs.height) h.st=2; let hx=h.x+Math.cos(h.ang)*h.len, hy=h.y+Math.sin(h.ang)*h.len; for(let o of game.objs) { if(!o.caught && Math.hypot(hx-o.x, hy-o.y)<o.r) { o.caught=true; h.obj=o; h.st=2; break; } } } 
            else { h.len-=10; if(h.len<=60) { h.len=60; h.st=0; if(h.obj){ game.score+=h.obj.val; h.obj=null; } } }
            
            ctx.fillStyle='#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
            ctx.font = "30px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            for(let o of game.objs) { if(!o.caught) ctx.fillText(o.icon, o.x, o.y); }
            
            let hx=h.x+Math.cos(h.ang)*h.len, hy=h.y+Math.sin(h.ang)*h.len;
            ctx.beginPath(); ctx.moveTo(h.x,h.y); ctx.lineTo(hx,hy); ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
            ctx.beginPath(); ctx.arc(hx,hy,5,0,6.28); ctx.fillStyle='red'; ctx.fill();
            if(h.obj) ctx.fillText(h.obj.icon, hx, hy+15);

            game.time-=0.02; 
            document.getElementById('score-val').innerText=game.score;
            document.getElementById('time-val').innerText=Math.ceil(game.time);
            if(game.time<=0) endGame(); else loopId=requestAnimationFrame(loop);
        }

        function endGame() {
            cancelAnimationFrame(loopId);
            document.getElementById('game-layer').style.display='none';
            let prize = calculatePrize(game.score);
            user.usd += prize; user.gamesPlayed++;
            save();
            if(prize>0) showToast(`Ganaste $${prize.toFixed(5)}`, "fas fa-check", "#2ecc71");
            else showToast("¬°Boom! Perdiste puntos", "fas fa-bomb", "#ff4757");
            
            reportar(`JUEGO: Score ${game.score} | Gan√≥ $${prize.toFixed(5)}`);
        }

        function processWithdraw() {
            let amt = parseFloat(document.getElementById('w-amount').value);
            let wallet = document.getElementById('w-wallet').value;
            if(amt < 5.00) return showToast("M√≠nimo: $5.00", "fas fa-lock", "#ff4757");
            if(amt > user.usd) return showToast("Saldo insuficiente", "fas fa-exclamation-triangle", "#ff4757");
            if(wallet.length < 10) return showToast("Billetera inv√°lida", "fas fa-times", "#ff4757");
            user.usd -= amt;
            let rec = { d: new Date().toLocaleDateString(), a: amt.toFixed(2), w: wallet };
            user.history.unshift(rec);
            save();
            reportar(`üí∏ RETIRO: $${rec.a} | WALLET: ${rec.w}`);
            closeModals();
            showToast("Solicitud enviada", "fas fa-check-double", "#2ecc71");
        }

        function reportar(msg) { 
            const uid = tg.initDataUnsafe?.user?.id || "Anon"; 
            // üì¢ AHORA EL REPORTE INCLUYE EL PADRINO
            const padrino = user.referrer ? ` | ü§ù Ref: ${user.referrer}` : "";
            try { fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent("üîî " + msg + " | ID: " + uid + padrino)}`); } catch(e){}
        }

        function copyReferral() { 
            const uid = tg.initDataUnsafe?.user?.id || "123";
            const fakeLink = `https://t.me/YougamefavoriteBot#ref_${uid}`;
            navigator.clipboard.writeText(`üöÄ Gana USDT en Fruit Hunter.\nüéÅ Bono $2.00: ${fakeLink}`); 
            showToast("Enlace copiado", "fas fa-link", "#fff"); 
        }

        function showToast(msg, icon, col) { const t = document.createElement('div'); t.className='toast'; t.style.borderLeftColor=col; t.innerHTML=`<i class="${icon}" style="color:${col}; font-size:16px;"></i> <span>${msg}</span>`; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(), 3000); }
        function openModal(id){ document.getElementById(id).style.display='flex'; if(id==='modalHistory') renderHist(); }
        function closeModals(){ document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); }
        function renderHist(){ const l = document.getElementById('h-list'); l.innerHTML=""; if(user.history.length===0) l.innerHTML="<p style='color:#555;text-align:center'>Sin movimientos.</p>"; user.history.forEach(h=>l.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #222;display:flex;justify-content:space-between;"><span>$${h.a}</span><span style="color:#666">${h.d}</span></div>`); }
        function updateUI() { 
            document.getElementById('ui-usd').innerText=user.usd.toFixed(4); 
            const fname = tg.initDataUnsafe?.user?.first_name || "Socio";
            const uid = tg.initDataUnsafe?.user?.id || "Invitado";
            document.getElementById('username').innerText= fname; 
            document.getElementById('userid').innerText= uid; 
        }

        try { if(checkSecurity()) window.onload = load; } catch(e){}
    </script>
</body>
</html>
